name: 'Elasticsearch plugin github action'
description: 'GitHub actio that builds elasticsearch plugins'


runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v4

  - name: Set environmeng
    shell: bash
    run: |
      echo "JDK_IMAGE=openjdk:14" >> "${GITHUB_ENV}"
      echo "GRADLE_ARGS=--info --stacktrace" >> "${GITHUB_ENV}"

  - name: Install podman
    run: |
      sudo apt-get update
      sudo apt-get install podman

  - name: Pull jdk image
    run: |
      podman pull ${{ env.JDK_IMAGE }}

  - name: Cache gradle wrapper
    uses: actions/cache@v4
    with:
      path: .gradle/wrapper
      key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
      restore-keys: ${{ runner.os }}-gradle-wrapper

  - name: Cache dependencies
    uses: actions/cache@v4
    with:
      path: .gradle/caches
      key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle', '**/*.gradle.kts') }}
      restore-keys: ${{ runner.os }}-gradle-deps

  - name: Assemble and run tests
    run: |
      set -eux
      PODMAN_RUN_ARGS="-it --rm --userns keep-id --net host -v $(pwd):/work -w /work -e HOME=/work ${{ env.JDK_IMAGE }}"
      podman run $PODMAN_RUN_ARGS ./gradlew assemble ${{ env.GRADLE_ARGS }}
      podman run $PODMAN_RUN_ARGS ./gradlew test ${{ env.GRADLE_ARGS }}
      podman run $PODMAN_RUN_ARGS ./gradlew integTest ${{ env.GRADLE_ARGS }}

  - name: Save release version
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/v')
    run: |
      set -eux
      RELEASE_VERSION=$(echo $GITHUB_REF| sed 's/refs\/tags\/v\(.*\)/\1/')
      echo $RELEASE_VERSION > build/distributions/release.version
      ls -lh build/distributions

  - name: Upload plugin artifact
    uses: actions/upload-artifact@v4
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/v')
    with:
      name: elasticsearch-plugin
      path: |
        build/distributions/release.version
        build/distributions/*.zip

